# Enrichment score heatmaps

A very common approach to make sense of your cells is to query several list of marker genes, retrieved from literature, and compute how enriched each cell is in each given list of genes. This is achieved by using `Seurat::AddModuleScore`. The scores can be then visualized as a Feature plot, but one can also aggregate the enrichment scores by any variable of interest, for instance the different clusters in the sample.

```{r echo = F}
sample <- readRDS("/b06x-isilon/b06x-g/G703/eblanco/projects/test_SC_datasets/sc_dataset.rds")
```

This kind of heatmaps can be easily computed using `SCpubr::do_EnrichmentHeatmap()`:

## Single grouping variable

```{r, fig.cap= "SCpubr::do_EnrichmentHeatmap with default parameters.", fig.width=6, fig.height=6}
genes <- list("Naive CD4+ T" = c("IL7R", "CCR7"),
              "CD14+ Mono" = c("CD14", "LYZ"),
              "Memory CD4+" = c("S100A4"),
              "B" = c("MS4A1"),
              "CD8+ T" = c("CD8A"),
              "FCGR3A+ Mono" = c("FCGR3A", "MS4A7"),
              "NK" = c("GNLY", "NKG7"),
              "DC" = c("FCER1A", "CST3"),
              "Platelet" = c("PPBP"))

p <- SCpubr::do_EnrichmentHeatmap(sample = sample,
                                  list_genes = genes)
p
```
By default, `SCpubr::do_EnrichmentHeatmap` aggregates the values by the current identity. However, other metadata variables can be used to aggregate for. For this, provide the name to `group.by` parameter.

```{r, fig.cap= "SCpubr::do_EnrichmentHeatmap with custom aggregation.", fig.width=6, fig.height=6}
# Custom aggregated values.
p <- SCpubr::do_EnrichmentHeatmap(sample = sample,
                                  list_genes = genes,
                                  group.by = "orig.ident")
p
```

The matrix can be transposed using `transpose = TRUE`.

```{r, fig.cap= "SCpubr::do_EnrichmentHeatmap transposed matrix.", fig.width=6, fig.height=6}
# Transposing the matrix.
p <- SCpubr::do_EnrichmentHeatmap(sample = sample,
                                  list_genes = genes,
                                  transpose = TRUE)
p
```


Rows and column names can be rotated using `column_names_rot`  and `row_names_rot` parameters, providing the desired angle.

```{r, fig.cap= "SCpubr::do_EnrichmentHeatmap transposed matrix different angle for column names.", fig.width=6, fig.height=6}
# Rotating the labels.
p <- SCpubr::do_EnrichmentHeatmap(sample = sample,
                                  list_genes = genes,
                                  transpose = TRUE,
                                  column_names_rot = 0)
p
```

## Multiple grouping variables
One can further split the output heatmap into several according to a second metadata variable. This is achieved by using `split.by` parameter.

```{r, fig.cap= "SCpubr::do_EnrichmentHeatmap transposed matrix using split.by.", fig.width=12, fig.height=6}
sample$modified_orig.ident <- sample(x = c("Sample_A", "Sample_B", "Sample_C"), 
                                     size = ncol(sample), 
                                     replace = T, 
                                     prob = c(0.2, 0.7, 0.1))

# Splitting by a second metadata variable.
p <- SCpubr::do_EnrichmentHeatmap(sample = sample,
                                  list_genes = genes,
                                  transpose = TRUE,
                                  column_names_rot = 0,
                                  split.by = "modified_orig.ident")
p
```


By default, heatmaps are joined horizontally. If you want them joined vertically, use `split.horizontal = FALSE`

```{r, fig.cap= "SCpubr::do_EnrichmentHeatmap transposed matrix using split.by joined vertically.", fig.width=6, fig.height=12}
# Splitting by a second metadata variable and joining vertically.
p <- SCpubr::do_EnrichmentHeatmap(sample = sample,
                                  list_genes = genes,
                                  transpose = TRUE,
                                  column_names_rot = 0,
                                  split.by = "modified_orig.ident",
                                  split.horizontal = FALSE)
p
```

## Changing the color scale.

If one wants to change the color scale of the heatmap, this can be accomplished by providing a two-color vector to `colors.use`. 

```{r, fig.cap= "SCpubr::do_EnrichmentHeatmap transposed matrix using split.by changing the color scale.", fig.width=12, fig.height=6}
# Modifying the color scale.
p <- SCpubr::do_EnrichmentHeatmap(sample = sample,
                                  list_genes = genes,
                                  transpose = TRUE,
                                  column_names_rot = 0,
                                  split.by = "modified_orig.ident",
                                  colors.use = colortools::opposite("steelblue", plot = F))
p
```

